# エナジー履歴遡及記録ガイド

## 📋 概要

エナジー履歴機能実装前に提出された日報のエナジー獲得履歴を遡及的に記録するスクリプトです。

## 🎯 目的

- メンバーが「履歴がありません」と表示される問題を解決
- 過去の日報から推測してエナジー履歴を作成
- マイページのエナジー履歴が充実する

## 📦 実行方法

### 1. スクリプトを実行

```bash
node scripts/backfill-energy-history.js
```

### 2. 実行結果の確認

スクリプトは以下を表示します：

- 処理したレポート数
- 処理したユーザー数
- 作成された履歴レコード数
- スキップされた履歴レコード数（既存）

### 3. 実行例

```
============================================================
  エナジー履歴遡及記録スクリプト
============================================================

🔄 エナジー履歴遡及記録を開始します...

📥 全レポートを取得中...
✅ 150件のレポートを取得しました

👥 12人のユーザーを検出しました

👤 山田太郎 (abc123...)
   レポート数: 15件
   ✅ 作成: 15件 | スキップ: 0件

👤 鈴木花子 (def456...)
   レポート数: 12件
   ✅ 作成: 8件 | スキップ: 4件

...

🎉 遡及記録が完了しました！
📊 統計:
   - 作成された履歴: 142件
   - スキップされた履歴: 8件
   - 処理したユーザー: 12人
```

## 🔧 技術詳細

### 作成される履歴レコード

```javascript
{
  userId: "ユーザーID",
  amount: 10, // 日報提出の基本エナジー
  type: "earn",
  sourceType: "daily_report",
  sourceId: "レポートID",
  description: "日報提出（遡及記録）",
  createdAt: Timestamp, // 元のレポート作成日時
  metadata: {
    backfilled: true, // 遡及記録フラグ
    backfilledAt: Timestamp, // 遡及実行日時
    reportDate: "2024-01-15" // 日報の日付
  }
}
```

### 重複チェック

- 既存の履歴レコードは自動的にスキップされます
- `sourceType="daily_report"` + `sourceId=レポートID`で判定
- 安全に複数回実行可能

### エナジー計算ロジック

**現在の実装（簡易版）**:
- 日報提出: 10E（固定）

**将来の拡張可能性**:
- ストリークボーナスの遡及計算
- チーム別ボーナスの適用
- 日報内容による加算

## ⚠️ 注意事項

### 実行前に確認すること

1. **Firebaseの接続確認**
   - `serviceAccountKey.json`が存在するか
   - Firebase Adminの権限が正しいか

2. **本番環境での実行**
   - 本番データを変更するため、慎重に実行
   - 可能であればテスト環境で先に実行

3. **バックアップ**
   - Firestoreの自動バックアップが有効か確認
   - 万が一に備えてデータエクスポート推奨

### 実行後の確認

1. **マイページで履歴を確認**
   - メンバーでログイン
   - マイページ → 「保有エナジー履歴」
   - 過去の日報分の履歴が表示されるか確認

2. **累計獲得エナジーの確認**
   - 「累計獲得の奇跡」セクション
   - エナジー総額が増加しているか確認

## 🚀 今後の改善案

### Phase 2: 精密な遡及計算

- ストリークボーナスの正確な計算
- 守護神強化に使用したエナジーの記録
- チーム別ボーナスの適用

### Phase 3: UI改善

- 遡及記録された履歴に特別なマーク表示
- 「遡及記録について」の説明モーダル
- 管理画面から遡及記録を実行できる機能

## 📞 トラブルシューティング

### エラー: "Cannot find module 'firebase-admin'"

```bash
npm install firebase-admin
```

### エラー: "serviceAccountKey.json not found"

プロジェクトルートに`serviceAccountKey.json`を配置してください。

### 履歴が作成されない

1. レポートに`userId`フィールドがあるか確認
2. ユーザーが`users`コレクションに存在するか確認
3. コンソールログでエラーメッセージを確認

## ✅ 成功基準

- [x] スクリプトが正常に完了する
- [x] エラーなく全ユーザーを処理
- [x] メンバーのマイページで履歴が表示される
- [x] 「履歴がありません」の表示が消える

---

**作成日**: 2026/1/8
**最終更新**: 2026/1/8
**バージョン**: 1.0.0
