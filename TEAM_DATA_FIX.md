# チーム不一致データ修正ガイド

**作成日**: 2026/1/7  
**目的**: 過去のUI仕様により発生したチーム不一致データの修正と再発防止

---

## 🚨 問題の概要

### 発生した問題

過去のUI仕様では、ユーザーが手動でチームを選択できたため、**退職サポートチーム（taishoku）のメンバーが副業チーム（fukugyou）として報告**してしまうデータ汚染が発生しました。

### 影響範囲

- ✅ reports コレクション: 不正確なチーム情報
- ✅ ダッシュボード: 集計値が誤って表示
- ✅ ランキング: チーム別ランキングが不正確

---

## 🔧 解決策

### 1. 過去データの修正（scripts/fix-team-mismatch.js）

#### スクリプトの機能

```javascript
✅ users コレクションから正しいチーム情報を取得
✅ reports コレクションの全レポートをスキャン
✅ userId と team の不一致を検出
✅ 不一致データを修正または削除
✅ 修正履歴を記録（fixedAt, fixedFrom, fixNote）
```

#### 実行方法

```bash
# 1. プロジェクトルートに移動
cd /Users/sugawaratomokazu/cc-insight

# 2. serviceAccountKey.json が存在することを確認
ls serviceAccountKey.json

# 3. スクリプトを実行
node scripts/fix-team-mismatch.js
```

#### 実行手順

```
ステップ1: スキャン
- 全ユーザーのチーム情報を取得
- 全レポートのチーム情報と照合
- 不一致データを検出・表示

ステップ2: 確認
- 不一致データの詳細を確認
- チーム別に集計して表示
- 実行オプションを選択

ステップ3: 実行
オプション1: 修正（推奨）
  - team フィールドを正しい値に変更
  - 修正履歴を記録
  
オプション2: 削除
  - 不一致データを完全削除
  
オプション3: キャンセル
  - 何もせず終了
```

#### 出力例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 チーム不一致データ修正スクリプト
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔍 チーム不一致データをスキャン中...

✅ ユーザー取得完了: 15人

📊 スキャン結果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
総レポート数: 245
正しいチーム: 230 (94%)
不一致レポート: 15 (6%)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 不一致データの詳細:

【fukugyou → taishoku】: 15件
  - 山田太郎 (taro@example.com)
    日付: 2026-01-05, 作成: 2026-01-05T10:30:00
    レポートID: abc123...
  - 佐藤花子 (hanako@example.com)
    日付: 2026-01-04, 作成: 2026-01-04T15:20:00
    レポートID: def456...
  ... 他 13件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
実行オプション:
  1. 修正 (正しいチームに変更)
  2. 削除 (不一致データを削除)
  3. キャンセル
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

選択してください (1/2/3): 1

⚠️  15件のレポートを修正しますか？ (yes/no): yes

🔧 修正処理を開始します...

✅ 修正: abc123... (fukugyou → taishoku)
✅ 修正: def456... (fukugyou → taishoku)
...

✅ バッチコミット完了 (15/15)

🎉 処理完了: 15件の修正が完了しました！
```

---

### 2. 再発防止（app/report/page.tsx）

#### 実装内容

```typescript
// ✅ チーム情報はuserProfile.teamから自動取得（変更不可）
const selectedTeam = userProfile?.team || "";

// ✅ チーム未設定の場合は送信をブロック
if (!selectedTeam) {
  setError("チーム設定が必要です。管理者に連絡してチームを設定してもらってください。");
  return;
}

// ✅ Firestoreへの送信時にselectedTeamを使用（100%正確）
const reportData = {
  userId: user.uid,
  team: selectedTeam,  // ← userProfile.teamから取得
  // ...
};
```

#### 効果

```
Before（修正前）:
- ユーザーがチームを手動選択
- 誤ったチームで報告可能 ❌

After（修正後）:
- チームは自動取得（userProfile.team）
- 手動選択は完全に不可能 ✅
- チーム未設定の場合は送信ブロック ✅
```

---

## 📋 実行チェックリスト

### 菅原副社長の作業

```
□ serviceAccountKey.json の準備
  - Firebase Console → プロジェクト設定 → サービスアカウント
  - 秘密鍵を生成してダウンロード
  - プロジェクトルートに配置

□ スクリプトの実行
  - ターミナルを開く
  - cd /Users/sugawaratomokazu/cc-insight
  - node scripts/fix-team-mismatch.js

□ スキャン結果の確認
  - 不一致データの件数を確認
  - チーム別の詳細を確認

□ 実行オプションの選択
  - 推奨: オプション1（修正）
  - 不正確なデータのみ削除したい場合: オプション2（削除）

□ 確認
  - yes と入力して実行

□ 完了確認
  - 処理完了メッセージを確認
  - ダッシュボードで数値を確認
```

---

## 🎯 期待される結果

### Before（修正前）

```
副業チームダッシュボード:
- 総再生数: 1,250,000（不正確）
- 総投稿数: 85（不正確）
- メンバー: 12人（実際は10人）
  ↑
  退職チームのメンバー2人が混入
```

### After（修正後）

```
副業チームダッシュボード:
- 総再生数: 1,100,000（正確）
- 総投稿数: 70（正確）
- メンバー: 10人（正確）

退職サポートチームダッシュボード:
- 総再生数: 150,000（新規表示）
- 総投稿数: 15（新規表示）
- メンバー: 2人（正確）
```

---

## 🔒 セキュリティ

### serviceAccountKey.json の取り扱い

```
⚠️ 絶対にGitHubにコミットしないこと
✅ .gitignore に含まれていることを確認
✅ 実行後は安全な場所に保管
✅ 不要になったら削除
```

### .gitignore の確認

```bash
# すでに .gitignore に含まれています
serviceAccountKey.json
*.json
```

---

## 🆘 トラブルシューティング

### Q1: serviceAccountKey.json が見つからない

```
A: Firebase Consoleから再ダウンロード
1. https://console.firebase.google.com/
2. プロジェクトを選択
3. プロジェクト設定（歯車アイコン）
4. サービスアカウント タブ
5. 「新しい秘密鍵の生成」をクリック
6. ダウンロードしたファイルをプロジェクトルートに配置
7. serviceAccountKey.json にリネーム
```

### Q2: スクリプト実行時にエラー

```
A: Node.js と firebase-admin のインストール確認
npm install
node --version  # v18以上推奨
```

### Q3: 不一致データが見つからない

```
A: すでに修正済みの可能性
✅ ダッシュボードで数値を確認
✅ 問題なければ作業完了
```

### Q4: 修正後もダッシュボードが変わらない

```
A: ブラウザキャッシュをクリア
1. Ctrl+Shift+R（Windows）/ Cmd+Shift+R（Mac）
2. ブラウザの履歴とキャッシュを削除
3. ページをリロード
```

---

## 📊 修正履歴の確認

### Firestore Consoleで確認

```
1. Firebase Console → Firestore Database
2. reports コレクション
3. 修正されたドキュメントを開く
4. 以下のフィールドが追加されている:
   - fixedAt: タイムスタンプ
   - fixedFrom: 修正前のチーム名
   - fixNote: "Auto-fixed by fix-team-mismatch.js"
```

---

## ✅ 最終確認

### 修正完了後のチェックリスト

```
□ スクリプト実行完了
□ 処理完了メッセージ確認
□ ダッシュボードで数値確認
  - 副業チーム: 正確な数値
  - 退職チーム: 正確な数値
  - 物販チーム: 変更なし
□ ランキングページ確認
  - チーム別ランキングが正確
□ 再発防止確認
  - 日報送信時にチーム変更不可
  - userProfile.teamが自動設定

全て✅なら完了🎉
```

---

## 📝 今後の運用

### チーム変更が必要な場合

```
1. 管理者が Firebase Console でユーザーのteamを変更
2. ユーザーが再ログイン
3. 新しいチームで自動的に報告される
4. 過去のレポートは変更されない（履歴として残る）
```

### 新メンバー追加時

```
1. Firebase Authentication でユーザー作成
2. Firestore の users コレクションに team を設定
3. 承認ステータスを approved に変更
4. ユーザーがログインして報告可能
```

---

**🎯 このガイドに従って実行すれば、データ汚染を100%解消し、今後の再発を完全に防止できます！**
