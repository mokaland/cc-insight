# ğŸ”¥ Firestore ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®Œå…¨è¨­å®šã‚¬ã‚¤ãƒ‰

**æœ€çµ‚æ›´æ–°**: 2026/1/7 18:46  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: cc-insight  
**ç·Šæ€¥å¯¾å¿œ**: å…¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œé‚

---

## ğŸš¨ å³åº§ã«ä½œæˆã™ã¹ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœ€å„ªå…ˆï¼‰

ä»¥ä¸‹ã®3ã¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’**ä»Šã™ã**ä½œæˆã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚‰ãŒãªã„ã¨å…¨ã¦ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

---

## ğŸ“‹ å¿…é ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§

### âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1: ãƒãƒ¼ãƒ åˆ¥ãƒ¬ãƒãƒ¼ãƒˆå–å¾—

**ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: `reports`  
**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `team` (Ascending)
- `createdAt` (Descending)

**å½±éŸ¿ã™ã‚‹ç”»é¢**:
- âœ… å…¨ä½“ã‚µãƒãƒªãƒ¼ï¼ˆ/dashboardï¼‰
- âœ… å‰¯æ¥­ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆ/dashboard/side-jobï¼‰
- âœ… é€€è·ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆ/dashboard/resignationï¼‰
- âœ… ç‰©è²©ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆ/dashboard/smartphoneï¼‰
- âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆ/rankingï¼‰

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// lib/firestore.ts: subscribeToReports()
query(
  collection(db, "reports"),
  where("team", "==", teamId),
  orderBy("createdAt", "desc")
)
```

**ä½œæˆæ‰‹é †**:
```
1. Firebase Console ã‚’é–‹ã
2. Firestore Database â†’ Indexes ã‚¿ãƒ–
3. ã€ŒCreate Indexã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. Collection ID: reports
5. Fields to index:
   - Field: team, Order: Ascending
   - Field: createdAt, Order: Descending
6. ã€ŒCreateã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. æ§‹ç¯‰å®Œäº†ã¾ã§3-5åˆ†å¾…æ©Ÿ
```

**ç›´æ¥ãƒªãƒ³ã‚¯ï¼ˆè¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDï¼‰**:
```
https://console.firebase.google.com/project/YOUR_PROJECT_ID/firestore/indexes?create_composite=Cgdyb3ZlcnRzEg4KBHRlYW0SAggBEg8KC2NyZWF0ZWRBdBICCAIYAQ
```

---

### âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2: æœŸé–“æŒ‡å®šãƒ¬ãƒãƒ¼ãƒˆå–å¾—

**ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: `reports`  
**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `date` (Ascending)

**å½±éŸ¿ã™ã‚‹ç”»é¢**:
- âœ… å…¨ã¦ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ï¼ˆæœŸé–“é¸æŠæ©Ÿèƒ½ï¼‰
- âœ… é€±æ¬¡/æœˆæ¬¡/å››åŠæœŸãƒ¬ãƒãƒ¼ãƒˆ

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// lib/firestore.ts: getReportsByPeriod()
query(
  collection(db, "reports"),
  where("date", ">=", startStr),
  where("date", "<=", endStr),
  orderBy("date", "desc")
)
```

**ä½œæˆæ‰‹é †**:
```
1. Firebase Console ã‚’é–‹ã
2. Firestore Database â†’ Indexes ã‚¿ãƒ–
3. ã€ŒCreate Indexã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. Collection ID: reports
5. Fields to index:
   - Field: date, Order: Ascending
6. ã€ŒCreateã€ã‚’ã‚¯ãƒªãƒƒã‚¯
```

**âš ï¸ æ³¨æ„**: ç¯„å›²ã‚¯ã‚¨ãƒªã¯é€šå¸¸è‡ªå‹•ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å¯¾å¿œå¯èƒ½ã§ã™ãŒã€`orderBy("date", "desc")`ã¨ã®çµ„ã¿åˆã‚ã›ã§è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

---

### âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ï¼ˆãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ï¼‰

**ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: `reports`  
**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `userId` (Ascending)
- `createdAt` (Descending)

**å½±éŸ¿ã™ã‚‹ç”»é¢**:
- âœ… ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°åˆ†æãƒšãƒ¼ã‚¸ï¼ˆ/admin/users/[userId]ï¼‰
- âœ… ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆ/mypageï¼‰
- âœ… ãƒãƒƒã‚¸åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ 

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// lib/firestore.ts: getUserStats()
query(
  collection(db, "reports"),
  where("userId", "==", userId),
  orderBy("createdAt", "desc")
)
```

**ä½œæˆæ‰‹é †**:
```
1. Firebase Console ã‚’é–‹ã
2. Firestore Database â†’ Indexes ã‚¿ãƒ–
3. ã€ŒCreate Indexã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. Collection ID: reports
5. Fields to index:
   - Field: userId, Order: Ascending
   - Field: createdAt, Order: Descending
6. ã€ŒCreateã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. æ§‹ç¯‰å®Œäº†ã¾ã§3-5åˆ†å¾…æ©Ÿ
```

---

## ğŸ¯ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã®æœ€é€Ÿæ‰‹é †

### æ–¹æ³•1: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ä½œæˆï¼ˆæ¨å¥¨ï¼‰

```
1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’é–‹ã
3. Consoleã‚¿ãƒ–ã‚’ç¢ºèª
4. ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãš:

   Error: The query requires an index. You can create it here: 
   https://console.firebase.google.com/v1/r/project/YOUR_PROJECT/firestore/indexes?create_composite=...

5. è¡¨ç¤ºã•ã‚ŒãŸURLã‚’ã‚¯ãƒªãƒƒã‚¯
6. Firebase ConsoleãŒé–‹ãã€å¿…è¦ãªè¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã‚‹
7. ã€ŒCreate Indexã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
8. å®Œäº†ï¼
```

### æ–¹æ³•2: æ‰‹å‹•ä½œæˆ

```
1. https://console.firebase.google.com/ ã‚’é–‹ã
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. Firestore Database â†’ Indexes
4. ã€ŒCreate Indexã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ä¸Šè¨˜ã®å„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã€Œä½œæˆæ‰‹é †ã€ã«å¾“ã£ã¦è¨­å®š
```

---

## ğŸ“Š ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çŠ¶æ³ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

| No | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | çŠ¶æ…‹ | å„ªå…ˆåº¦ |
|---|---|---|---|---|---|
| 1 | ãƒãƒ¼ãƒ åˆ¥ | reports | team + createdAt | ğŸ”´ æœªä½œæˆ | ğŸ”¥ æœ€é«˜ |
| 2 | æœŸé–“æŒ‡å®š | reports | date | ğŸ”´ æœªä½œæˆ | ğŸ”¥ æœ€é«˜ |
| 3 | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ | reports | userId + createdAt | ğŸ”´ æœªä½œæˆ | âš ï¸ é«˜ |
| 4 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ | users | createdAt | âœ… è‡ªå‹• | - |

---

## âš ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ä¸­ã®æŒ™å‹•

### æ§‹ç¯‰ä¸­ï¼ˆBuildingçŠ¶æ…‹ï¼‰

```
- æ‰€è¦æ™‚é–“: 3-10åˆ†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡ã«ä¾å­˜ï¼‰
- ã“ã®é–“ã€è©²å½“ã‚¯ã‚¨ãƒªã¯å¤±æ•—ã™ã‚‹
- UIã«ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ä¸­ï¼‰ã€ã¨è¡¨ç¤º
```

### æ§‹ç¯‰å®Œäº†å¾Œ

```
1. Firestore Console ã§ã€ŒEnabledã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
2. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆCtrl+R / Cmd+Rï¼‰
3. ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ãŸã®ã«ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„

```
A: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€ŒEnabledã€ã«ãªã£ã¦ã„ã‚‹ã‹
2. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‹
3. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ãŸã‹
4. ä»–ã«ã‚‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ï¼ˆConsoleç¢ºèªï¼‰
```

### Q2: è¤‡æ•°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

```
A: 1ã¤ãšã¤ä½œæˆã—ã¦ãã ã•ã„
1. æœ€åˆã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®URLã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå®Œäº†ã‚’å¾…ã¤
3. ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰
4. æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ã€ãã®URLã‚’ã‚¯ãƒªãƒƒã‚¯
5. ç¹°ã‚Šè¿”ã—
```

### Q3: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ãŒçµ‚ã‚ã‚‰ãªã„

```
A: ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã€1æ™‚é–“ä»¥ä¸Šã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™
- Firebase Consoleã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
- ã€ŒBuildingã€ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é–“ã¯å¾…æ©Ÿ
- 24æ™‚é–“çµŒã£ã¦ã‚‚å®Œäº†ã—ãªã„å ´åˆã¯Firebaseã‚µãƒãƒ¼ãƒˆã«é€£çµ¡
```

---

## ğŸ“š å‚è€ƒæƒ…å ±

### Firebaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Firestore Indexes](https://firebase.google.com/docs/firestore/query-data/indexing)
- [Index Best Practices](https://firebase.google.com/docs/firestore/best-practices)
- [Composite Indexes](https://firebase.google.com/docs/firestore/query-data/index-overview#composite_indexes)

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…å‚ç…§

- `lib/firestore.ts` - å…¨ã‚¯ã‚¨ãƒªå®Ÿè£…
- `app/dashboard/*` - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸
- `app/ranking/page.tsx` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸
- `app/admin/users/[userId]/page.tsx` - ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸

---

## âœ… å®Œäº†ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```
è…åŸå‰¯ç¤¾é•·ã®ä½œæ¥­:
[ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼ˆteam + createdAtï¼‰ã‚’ä½œæˆ
[ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ï¼ˆdateï¼‰ã‚’ä½œæˆ
[ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3ï¼ˆuserId + createdAtï¼‰ã‚’ä½œæˆ
[ ] å…¨ã¦ãŒã€ŒEnabledã€ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
[ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
[ ] ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
[ ] ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª
[ ] ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª
```

---

**ğŸ¯ ã“ã®3ã¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚Œã°ã€å…¨ã¦ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼**
